



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://learn2learn.net/_build/pydocmd/tutorials/anil_tutorial/ANIL_tutorial/">
      
      
        <meta name="author" content="SÃ©b Arnold">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../../assets/img/favicons/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.4, mkdocs-material-4.6.3">
    
    
      
        <title>Feature Reuse with ANIL - learn2learn</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../../../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Source Sans Pro","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    
      <link rel="stylesheet" href="../../../../../assets/css/l2l_material.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-68693545-3", "seba-1511.github.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#feature-reuse-with-anil" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://learn2learn.net/" title="learn2learn" aria-label="learn2learn" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../../../../assets/img/learn2learn_white.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              learn2learn
            </span>
            <span class="md-header-nav__topic">
              
                Feature Reuse with ANIL
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/learnables/learn2learn/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    learnables/learn2learn
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://learn2learn.net/" title="learn2learn" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../../../../assets/img/learn2learn_white.png" width="48" height="48">
      
    </a>
    learn2learn
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/learnables/learn2learn/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    learnables/learn2learn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../tutorials/getting_started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../tutorials/anil_tutorial/ANIL_tutorial/" title="Feature Reuse with ANIL" class="md-nav__link">
      Feature Reuse with ANIL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../tutorials/task_transform_tutorial/transform_tutorial/" title="Demystifying Task-Transforms" class="md-nav__link">
      Demystifying Task-Transforms
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn/" title="learn2learn" class="md-nav__link">
      learn2learn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.data/" title="learn2learn.data" class="md-nav__link">
      learn2learn.data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.algorithms/" title="learn2learn.algorithms" class="md-nav__link">
      learn2learn.algorithms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.optim/" title="learn2learn.optim" class="md-nav__link">
      learn2learn.optim
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.nn/" title="learn2learn.nn" class="md-nav__link">
      learn2learn.nn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.vision/" title="learn2learn.vision" class="md-nav__link">
      learn2learn.vision
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../docs/learn2learn.gym/" title="learn2learn.gym" class="md-nav__link">
      learn2learn.gym
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../examples/vision/" title="Computer Vision" class="md-nav__link">
      Computer Vision
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../examples/rl/" title="Reinforcement Learning" class="md-nav__link">
      Reinforcement Learning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../examples/optim/" title="Optimization" class="md-nav__link">
      Optimization
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../../community/" title="Community" class="md-nav__link">
      Community
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../../changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/learnables/learn2learn/" title="GitHub" class="md-nav__link">
      GitHub
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anil-algorithm" class="md-nav__link">
    ANIL algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-anil-with-learn2learn" class="md-nav__link">
    Using ANIL with learn2learn
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anil-implementation" class="md-nav__link">
    ANIL Implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/learnables/learn2learn/edit/master/docs/_build/pydocmd/tutorials/anil_tutorial/ANIL_tutorial.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="feature-reuse-with-anil">Feature Reuse with ANIL<a class="headerlink" href="#feature-reuse-with-anil" title="Permanent link">&para;</a></h1>
<p>Written by <a href="https://ewinapun.tk">Ewina Pun</a> on 3/30/2020.</p>
<p>In this article, we will dive into a meta-learning algorithm called ANIL (Almost No Inner Loop) presented by <a href="https://arxiv.org/abs/1909.09157.pdf">Raghu et al., 2019</a>, and explain how to implement it with learn2learn.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial is written for experienced PyTorch users who are getting started with meta-learning.</p>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<ul>
<li>We look into how ANIL takes advantage of feature reuse for few-shot learning.</li>
<li>ANIL simplifies MAML by removing the inner loop <em>for all but</em> the task-specific head of the underlying neural network.</li>
<li>ANIL performs as well as MAML on benchmark few-shot classification and reinforcement learning tasks, and is computationally more efficient than MAML.</li>
<li>We implement ANIL with learn2learn and provide additional results of how ANIL performs on other datasets.</li>
<li>Lastly, we explain the implementation code step-be-step, making it easy for users to try ANIL on other datasets.</li>
</ul>
<h2 id="anil-algorithm">ANIL algorithm<a class="headerlink" href="#anil-algorithm" title="Permanent link">&para;</a></h2>
<p>Among various meta-learning algorithms for few-shot learning, MAML (model-agnostic meta-learning) <a href="https://arxiv.org/abs/1703.03400.pdf">(Finn et al. 2017)</a> has been highly popular due to its substantial performance on several benchmarks. Its idea is to establish a meta-learner that seeks an initialization useful for fast learning of different tasks, then adapt to specific tasks quickly (within a few steps) and efficiently (with only a few examples). There are two types of parameter updates: the outer loop and the inner loop. The <strong><em>outer loop</em></strong> updates the meta-initialization of the neural network parameters to a setting that enables fast adaptation to new tasks. The <strong><em>inner loop</em></strong> takes the outer loop initialization and performs task-specific adaptation over a few labeled samples. To read more about meta-learning and MAML, you can read the summary article written by Finn on <a href="https://bair.berkeley.edu/blog/2017/07/18/learning-to-learn/">learning to learn</a> and Lilian Weng's <a href="https://lilianweng.github.io/lil-log/2018/11/30/meta-learning.html">review on meta-learning</a>.</p>
<p>In 2019, Raghu et al. conjectured that we can obtain the same rapid learning performance of MAML solely through feature reuse. To test this hypothesis, they introduced ANIL (almost no inner loop), a simplified algorithm of MAML that is equally effective but computationally faster.</p>
<p><strong>Rapid learning vs. feature reuse</strong></p>
<p style="text-align:center;">
<img src="/tutorials/anil_tutorial/rapid_learning_or_feature_reuse.png" style="width:100%; vertical-align: middle;"/>
    <div class="caption">
    Visualizations of rapid learning and feature reuse. Diagram from Raghu et al., 2019.
    </div>
</p>

<p>Before we describe ANIL, we have to understand the difference between rapid learning and feature reuse. In <strong><em>rapid learning</em></strong>, the meta-initialization in the outer loop results in a parameter setting that is favorable for fast learning, thus significant adaptation to new tasks can rapidly take place in the inner loop. In <strong><em>feature reuse</em></strong>, the meta-initialization already contains useful features that can be reused, so little adaptation on the parameters is required in the inner loop. To prove feature reuse is a competitive alternative to rapid learning in MAML, the authors proposed a simplified algorithm, ANIL, where the inner loop is removed for all but the task-specific head of the underlying neural network during training and testing.</p>
<p><strong>ANIL vs. MAML</strong></p>
<p>Now, let us illustrate the difference mathematically. Let <script type="math/tex">\theta</script> be the set of meta-initialization parameters for the feature extractable layers of the network and <script type="math/tex">w</script> be the meta-initialization parameters for the head. We obtain the label prediction <script type="math/tex">\hat{y} = w^T\phi_\theta(x)</script>, where x is the input data and <script type="math/tex">\phi</script> is a feature extractor parametrized by <script type="math/tex">\theta</script>.</p>
<p>Given <script type="math/tex">\theta_i</script> and <script type="math/tex">w_i</script> at iteration step <script type="math/tex">i</script>, the outer loop updates both parameters via gradient descent:
<script type="math/tex; mode=display">\theta_{i+1} = \theta_i - \alpha\nabla_{\theta_i}\mathcal{L}_{\tau}(w^{\prime \top}_i\phi_{\theta^\prime_i}(x), y)</script>
<script type="math/tex; mode=display">w_{i+1} = w_i - \alpha\nabla_{w_i}\mathcal{L}_{\tau}(w^{\prime \top}_i\phi_{\theta^\prime_i}(x), y)</script>
</p>
<p>where <script type="math/tex">\mathcal{L}_\tau</script> is the loss computed for task <script type="math/tex">\tau</script>, and <script type="math/tex">\alpha</script> is the meta learning rate in the outer loop.
Notice how the gradient is taken with respect to the initialization parameters <script type="math/tex">w_i</script> and <script type="math/tex">\theta_i</script>, but the loss is computed on the adapted parameters <script type="math/tex">\theta_i^\prime</script> and <script type="math/tex">w_i^\prime</script>.
For one adaptation step in the inner loop, ANIL computes those adapted parameters as:
<script type="math/tex; mode=display">\theta_{i}^\prime = \theta_i</script>
<script type="math/tex; mode=display">w_{i}^\prime = w_i - \beta\nabla_{w_i}\mathcal{L}_{\tau}(w_i^T\phi_{\theta_i}(x), y)</script>
where <script type="math/tex">\beta</script> is the learning rate of the inner loop.
Concretely, ANIL keeps the feature extractor constant and only adapts the head with gradient descent.
In contrast, MAML updates both the head and the feature extractor:
<script type="math/tex; mode=display">\theta_{i}^\prime = \theta_i - \beta\nabla_{\theta_i}\mathcal{L}_{\tau}(w_i^T\phi_{\theta_i}(x), y)</script>
<script type="math/tex; mode=display">w_{i}^\prime = w_i - \beta\nabla_{w_i}\mathcal{L}_{\tau}(w_i^T\phi_{\theta_i}(x), y).</script>
</p>
<p>Unsurprisingly, ANIL is much more computationally efficient since it requires fewer updates in the inner loop. What might be surprising, is that this efficiency comes at almost no cost in terms of performance.</p>
<p><strong>Results</strong></p>
<p>ANIL provides fast adaptation in the absence of almost all inner loop parameter updates, while still matching the performance of MAML on few-shot image classification with Mini-ImageNet and Omniglot and standard reinforcement learning tasks.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Omniglot-20way-1shot</th>
<th>Omniglot-20way-5shot</th>
<th>Mini-ImageNet-5way-1shot</th>
<th>Mini-ImageNet-5way-5shot</th>
</tr>
</thead>
<tbody>
<tr>
<td>MAML</td>
<td>93.7 Â± 0.7</td>
<td>96.4 Â± 0.1</td>
<td>46.9 Â± 0.2</td>
<td>63.1 Â± 0.4</td>
</tr>
<tr>
<td>ANIL</td>
<td>96.2 Â± 0.5</td>
<td>98.0 Â± 0.3</td>
<td>46.7 Â± 0.4</td>
<td>61.5 Â± 0.5</td>
</tr>
</tbody>
</table>
<h2 id="using-anil-with-learn2learn">Using ANIL with learn2learn<a class="headerlink" href="#using-anil-with-learn2learn" title="Permanent link">&para;</a></h2>
<p>With our understanding of how ANIL works, we are ready to implement the algorithm. An example implementation on the FC100 dataset is available at: <a href="https://github.com/learnables/learn2learn/blob/master/examples/vision/anil_fc100.py"><code>anil_fc100.py</code></a>. Using this implementation, we are able to obtain the following results on datasets such as Mini-ImageNet, CIFAR-FS and FC100 as well.</p>
<table>
<thead>
<tr>
<th>Dataset</th>
<th>Architecture</th>
<th>Ways</th>
<th>Shots</th>
<th>Original</th>
<th>learn2learn</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mini-ImageNet</td>
<td>CNN</td>
<td>5</td>
<td>5</td>
<td>61.5%</td>
<td>63.2%</td>
</tr>
<tr>
<td>CIFAR-FS</td>
<td>CNN</td>
<td>5</td>
<td>5</td>
<td>n/a</td>
<td>68.3%</td>
</tr>
<tr>
<td>FC100</td>
<td>CNN</td>
<td>5</td>
<td>5</td>
<td>n/a</td>
<td>47.6%</td>
</tr>
</tbody>
</table>
<h2 id="anil-implementation">ANIL Implementation<a class="headerlink" href="#anil-implementation" title="Permanent link">&para;</a></h2>
<p>This section breaks down step-by-step the ANIL implementation with our example code.</p>
<p><strong>Creating dataset</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">l2l</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FC100</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;~/data&#39;</span><span class="p">,</span>
                                          <span class="n">transform</span><span class="o">=</span><span class="n">tv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                          <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">l2l</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">MetaDataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>First, data are obtained and separated into train, validation and test dataset with <a href="https://github.com/learnables/learn2learn/blob/master/learn2learn/vision/datasets/fc100.py"><code>l2l.vision.datasets.FC100</code></a>. <code>tv.transforms.ToTensor()</code> converts Python Imaging Library (PIL) images to PyTorch tensors. <code>l2l.data.MetaDataset</code> is a thin wrapper around torch datasets that automatically generates bookkeeping information to create new tasks.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">train_transforms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FusedNWaysKShots</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">ways</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">shots</span><span class="p">),</span>
    <span class="n">LoadData</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span>
    <span class="n">RemapLabels</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span>
    <span class="n">ConsecutiveLabels</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">train_tasks</span> <span class="o">=</span> <span class="n">l2l</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TaskDataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span>
                                   <span class="n">task_transforms</span><span class="o">=</span><span class="n">train_transforms</span><span class="p">,</span>
                                   <span class="n">num_tasks</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p><code>l2l.data.TaskDataset</code> creates a set of tasks from the MetaDataset using a list of task transformations:</p>
<ul>
<li>
<p><code>FusedNWaysKShots(dataset, n=ways, k=2*shots)</code>: efficient implementation to keep <script type="math/tex">k</script> data samples from <script type="math/tex">n</script> randomly sampled labels.</p>
</li>
<li>
<p><code>LoadData(dataset)</code>: loads a sample from the dataset given its index.</p>
</li>
<li><code>RemapLabels(dataset)</code>: given samples from <script type="math/tex">n</script> classes, maps the labels to <script type="math/tex">0, \dots, n</script>.</li>
<li><code>ConsecutiveLabels(dataset)</code>: re-orders the samples in the task description such that they are sorted in consecutive order.</li>
</ul>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Why <code>k = 2*shots</code>?</p>
<p>The number of samples <script type="math/tex">k</script> is twice the number of shots because one half of the samples are for adaption and the other half are for evaluation in the inner loop.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more details, please refer to the <a href="http://learn2learn.net/docs/learn2learn.data/">documentation of learn2learn.data</a>.</p>
</div>
<p><strong>Creating model</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">features</span> <span class="o">=</span> <span class="n">l2l</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ConvBase</span><span class="p">(</span><span class="n">output_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)))</span>
<span class="n">features</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">ways</span><span class="p">)</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">l2l</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">MAML</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">fast_lr</span><span class="p">)</span>
<span class="n">head</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We then instantiate two modules, one for features and one for the head. ConvBase instantiates a four-layer CNN, and the head is a fully connected layer. Because we are not updating the feature extractor parameters, we only need to wrap the head with the <code>l2l.algorithms.MAML()</code> wrapper, which takes in the fast adaptation learning rate <code>fast_lr</code> used for the inner loop later.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more details on the MAML wrapper, please refer to the <a href="http://learn2learn.net/docs/learn2learn.algorithms/">documentation of l2l.algorithms</a>.</p>
</div>
<p><strong>Optimization setup</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">all_parameters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">all_parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">meta_lr</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>Next, we set up the optimizer with mini-batch SGD using <code>torch.optim.Adam</code>, which takes in both feature and head parameters, and learning rate <code>meta_lr</code> used for the outer loop.</p>
<p><strong>Outer loop</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">meta_bsz</span><span class="p">):</span>
        <span class="n">learner</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">train_tasks</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="o">...</span>
</code></pre></div>
</td></tr></table>
<p>For training, validation and testing, we first sample a task, then copy the head with <code>head.clone()</code>, which is a method exposed by the MAML wrapper for PyTorch modules, akin to <code>tensor.clone()</code> for PyTorch tensors. Calling <code>clone()</code> allows us to update the parameters of the clone while maintaining ability to back-propagate to the parameters in <code>head</code>. There's no need for <code>feature.clone()</code> as we are only adapting the head.</p>
<p><strong>Inner loop</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">fast_adapt</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">learner</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">adaptation_steps</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span>
               <span class="n">ways</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Separate data into adaptation/evaluation sets</span>
    <span class="n">adaptation_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">adaptation_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shots</span><span class="o">*</span><span class="n">ways</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">evaluation_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="o">~</span><span class="n">adaptation_indices</span><span class="p">)</span>
    <span class="n">adaptation_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">adaptation_indices</span><span class="p">)</span>
    <span class="n">adaptation_data</span><span class="p">,</span> <span class="n">adaptation_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">adaptation_indices</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">adaptation_indices</span><span class="p">]</span>
    <span class="n">evaluation_data</span><span class="p">,</span> <span class="n">evaluation_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">evaluation_indices</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">evaluation_indices</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">adaptation_steps</span><span class="p">):</span>
        <span class="n">train_error</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">learner</span><span class="p">(</span><span class="n">adaptation_data</span><span class="p">),</span> <span class="n">adaptation_labels</span><span class="p">)</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">train_error</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">learner</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span>
    <span class="n">valid_error</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">evaluation_labels</span><span class="p">)</span>
    <span class="n">valid_accuracy</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">evaluation_labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_error</span><span class="p">,</span> <span class="n">valid_accuracy</span>
</code></pre></div>
</td></tr></table>
<p>In <code>fast_adapt()</code>, we separate data into adaptation and evaluation sets with <code>k</code> shot samples each. In each adaptation step, <code>learner.adapt()</code> takes a gradient step on the loss and updates the cloned parameter, <code>learner</code>, such that we can back-propagate through the adaptation step. Under the hood, this is achieved by calling <code>torch.autograd.grad()</code> and setting <code>create_graph=True</code>. <code>fast_adapt()</code> then returns the evaluation loss and accuracy based on the predicted and true labels.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Why is the number of adaptation steps so small?</p>
<p>To demonstrate fast adaptation, we want the algorithm to adapt to each specific task quickly within a few steps. Since the number of samples is so small in few-shot learning, increasing number of adaptation steps would not help raising the performance.</p>
</div>
<p><strong>Closing the outer loop</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">evaluation_error</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">meta_train_error</span> <span class="o">+=</span> <span class="n">evaluation_error</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">meta_train_accuracy</span> <span class="o">+=</span> <span class="n">evaluation_accuracy</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="o">...</span>
<span class="c1"># Average the accumulated gradients and optimize</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_parameters</span><span class="p">:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">meta_bsz</span><span class="p">)</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>We compute the gradients with <code>evaluation_error.backward()</code> right after the inner loop updates to free activation and adaptation buffers from memory as early as possible. Lastly, after collecting the gradients, we average the accumulated gradients and updates the parameter at the end of each iteration with <code>optimizer.step()</code>.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>Having explained the inner-workings of ANIL and its code implementation with learn2learn, I hope this tutorial will be helpful to those who are interested in using ANIL for their own research and applications.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ol>
<li>Raghu, A., Raghu, M., Bengio, S., &amp; Vinyals, O. (2019). Rapid Learning or Feature Reuse? Towards Understanding the Effectiveness of MAML. In arXiv [cs.LG]. arXiv. http://arxiv.org/abs/1909.09157</li>
<li>Finn, C., Abbeel, P., &amp; Levine, S. (2017). Model-Agnostic Meta-Learning for Fast Adaptation of Deep Networks. In arXiv [cs.LG]. arXiv. http://arxiv.org/abs/1703.03400</li>
</ol>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/learnables" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/seba1511" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://github.com/learnables/learn2learn/issues/new" target="_blank" rel="noopener" title="bug" class="md-footer-social__link fa fa-bug"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.2.4",url:{base:"../../../../.."}})</script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/mathtex-script-type.min.js"></script>
      
    
  </body>
</html>